#!/usr/bin/env python3

# Copyright The OpenTelemetry Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from argparse import REMAINDER, ArgumentParser
from logging import getLogger
from os import environ, execl, getcwd
from os.path import abspath, dirname, pathsep
from re import sub
from shutil import which

### === pkg_resources ãŒ import ã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Šã€
### === pkg_resources å†…ã® @call_aside é–¢æ•° ( _initialize, _initialize_master_working_set ) ãŒå®Ÿè¡Œã•ã‚Œã‚‹
from pkg_resources import iter_entry_points

from opentelemetry.instrumentation.version import __version__

_logger = getLogger(__name__)


def run() -> None:
    print("=== ã“ã‚ŒãŒã€auto_instrument ã® run() é–¢æ•°ã®é–‹å§‹åœ°ç‚¹")
    parser = ArgumentParser(
        description="""
        opentelemetry-instrument automatically instruments a Python
        program and its dependencies and then runs the program.
        """,
        epilog="""
        Optional arguments (except for --help and --version) for opentelemetry-instrument
        directly correspond with OpenTelemetry environment variables. The
        corresponding optional argument is formed by removing the OTEL_ or
        OTEL_PYTHON_ prefix from the environment variable and lower casing the
        rest. For example, the optional argument --attribute_value_length_limit
        corresponds with the environment variable
        OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT.

        These optional arguments will override the current value of the
        corresponding environment variable during the execution of the command.
        """,
    )

    argument_otel_environment_variable = {}
    
    # ã“ã‚Œã«ã‚ˆã‚Š pkg_resources ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã€pkg_resources ã®ãªã‹ã§ WorkingSet ã« distribution ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹
    """
    test_iter_entry_points = iter_entry_points(
        "opentelemetry_environment_variables"
    )
    """

    # å„ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ( api, instrument, sdk ã«å¯¾ã—ã¦... )
    for entry_point in iter_entry_points(
        "opentelemetry_environment_variables"
    ):
        environment_variable_module = entry_point.load()

        for attribute in dir(environment_variable_module):
            if attribute.startswith("OTEL_"):
                argument = sub(r"OTEL_(PYTHON_)?", "", attribute).lower()

                parser.add_argument(
                    f"--{argument}",
                    required=False,
                )

                # ç’°å¢ƒå¤‰æ•°è¾æ›¸ã« KeyVal ã‚’æ ¼ç´ã—ã¦ã‚‹
                # argument_otel_environment_variable['logs_exporter] = "OTEL_LOGS_EXPORTER"  çš„ãªæ„Ÿã˜
                argument_otel_environment_variable[argument] = attribute

    # ã“ã®è¾ºã¯ CLI ã®èª¬æ˜æ–‡ã ãªã€‚parser ã¯ãã‚Œã‹
    parser.add_argument(
        "--version",
        help="print version information",
        action="version",
        version="%(prog)s " + __version__,
    )
    parser.add_argument("command", help="Your Python application.")
    parser.add_argument(
        "command_args",
        help="Arguments for your application.",
        nargs=REMAINDER,
    )

    args = parser.parse_args()

    # ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã§ãã‚‹å¤‰æ•°åˆ†ã ã‘å›ã—ã¦ã„ã‚‹
    for argument, otel_environment_variable in (
        argument_otel_environment_variable
    ).items():
        # argument ãŒ 'logs_exporter' ã§ã€otel_environment_variable ãŒ "OTEL_LOGS_EXPORTER"
        value = getattr(args, argument)
        if value is not None:
            # å®Ÿè¡Œæ™‚ã« args ãŒã‚ã£ãŸã‚‰è¨­å®šã™ã‚‹
            # opentelemetry-instrument --exporter_otlp_traces_protocol=grpc flask run --port 8080
            # ã¨ã™ã‚‹ã¨ã€grpc ãŒè¨­å®šã•ã‚Œã‚‹
            environ[otel_environment_variable] = value
            
    print("ğŸŒ±ğŸŒ±ğŸŒ± åˆæœŸè¨­å®šæ™‚ã«è¨­å®šã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•° === ")
    for key, val in environ.items():
        if key.startswith("OTEL_"):
            print(key, " = ", val)
    print("ğŸŒ±ğŸŒ±ğŸŒ±")
        
    # None ã«ãªã£ã¦ãŸ
    python_path = environ.get("PYTHONPATH")

    if not python_path:
        python_path = []

    else:
        python_path = python_path.split(pathsep)

    # ã“ã®æ™‚ç‚¹ã§ python_path ã¯ []
    
    cwd_path = getcwd() # /Users/zuck3rx/git/event/cndt2023-demo/misk/research-python

    # This is being added to support applications that are being run from their
    # own executable, like Django.
    # FIXME investigate if there is another way to achieve this
    if cwd_path not in python_path:
        python_path.insert(0, cwd_path) # ã“ã“ã§ä¸Šã® python path ãŒè¨­å®šã•ã‚Œã‚‹

    filedir_path = dirname(abspath(__file__))
    # /Users/zuck3rx/git/event/cndt2023-demo/misk/research-python/lib/python3.11/site-packages/opentelemetry/instrumentation/auto_instrumentation
    # print(filedir_path)

    python_path = [path for path in python_path if path != filedir_path]
    # ['/Users/zuck3rx/git/event/cndt2023-demo/misk/research-python']
    # print(python_path)

    python_path.insert(0, filedir_path)
    # ['/Users/zuck3rx/git/event/cndt2023-demo/misk/research-python/lib/python3.11/site-packages/opentelemetry/instrumentation/auto_instrumentation', '/Users/zuck3rx/git/event/cndt2023-demo/misk/research-python']
    # print(python_path)

    environ["PYTHONPATH"] = pathsep.join(python_path)
    # PYTHONPATH ã« /auto_instrumentatio ã‚’è¿½åŠ 

    executable = which(args.command)
    # print(executable)
    # flask ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç‰¹å®š
    # ã¤ã¾ã‚Šã€ã“ã“ã§ flask ã‚’å†å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã‹
    print("â­ï¸â­ï¸â­ï¸ executable ã®å†å®Ÿè¡Œã ãœï¼ï¼: ", executable, executable, *args.command_args)
    print("\n")
    # ã“ã“ã§å†å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€sitecustomize.py ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹...( process ãŒå†ä½œæˆã•ã‚Œã‚‹ãŸã‚ã‚‰ã—ã„ )
    # å†å®Ÿè¡Œã¨ã„ã†ã‹ã€å…ƒã€… opentelemetry-instrument ãƒã‚¤ãƒŠãƒªãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¦ã€ãã‚ŒãŒã€ python app.py ã«ç½®ãæ›ã‚ã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹æ„Ÿã˜
    # ã“ã‚Œã«ã‚ˆã‚Šã€sitecustomize.py ã®å®Ÿè¡ŒãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
    execl(executable, executable, *args.command_args)