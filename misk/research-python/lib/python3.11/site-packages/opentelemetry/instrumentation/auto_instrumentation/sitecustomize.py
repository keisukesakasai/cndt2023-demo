# Copyright The OpenTelemetry Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# sitecustomize.py ã¯å®Ÿè¡Œã•ã‚Œã‚‹ã‚‰ã—ã„ã€‚å‹æ‰‹ã«
# çŸ¥ã‚‰ã‚“ã‚ˆ...

from logging import getLogger
from os import environ
from os.path import abspath, dirname, pathsep

# ã†ãƒ¼ã‚“ã€ã“ã“ã§ _load ãŒ import ã•ã‚Œã‚‹ã¨ãã®ä¸­ã§ pkg_resources ãŒ import ã•ã‚Œã¦ã‚‹ã‹ã‚‰
# @call_aside é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã£ã¦ã„ã†ç†è§£ã§ã„ã„ã®ã ã‚ã†ã‹ï¼ŸãŸã ã€ã“ã“ã§ã¯ãã‚Œã ã‘ã€‚ã€‚ã€‚(ã¾ãã€ã“ã‚Œã§ã„ã„ã‹)
from opentelemetry.instrumentation.auto_instrumentation._load import (
    _load_configurators,
    _load_distro,
    _load_instrumentors,
)

from opentelemetry.instrumentation.utils import _python_path_without_directory

logger = getLogger(__name__)


def initialize():
    # prevents auto-instrumentation of subprocesses if code execs another python process
    environ["PYTHONPATH"] = _python_path_without_directory(
        environ["PYTHONPATH"], dirname(abspath(__file__)), pathsep
    )
    print("=== environ['PYTHONPATH'] ã¯ ", environ["PYTHONPATH"])
    # /Users/zuck3rx/git/event/cndt2023-demo/misk/research-python ãŒè¨­å®šã•ã‚Œã‚‹

    try:
        # ã“ã“ã§è‰²ã€… load ã—ã¦ã„ã‚‹ãª...
        
        # load ã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Šã€BaseDistro Class ã¨ã—ã¦ã€OpenTelemetryDistro ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚Œã‚‹
        distro = _load_distro()
        print("=== load ã—ã¦è¿”ã•ã‚Œã‚‹ distro ã¯ ", distro) # opentelemetry.distro.OpenTelemetryDistro
        # OpenTelemetryDistro ã® _configure ã‚’å®Ÿè¡Œã—ã¦ã€ç’°å¢ƒå¤‰æ•°
        # OTEL_TRACES_EXPORTER, OTEL_METRICS_EXPORTER, OTEL_EXPORTER_OTLP_PROTOCOL ã‚’è¨­å®šã—ã¦ã„ã‚‹ã£ã½ã„
        distro.configure()
        
        # opentelemetry_configurator group ã«å±ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
        # ã“ã‚Œ OpenTelemetryConfiguraor ã£ã¦ã„ã†ã‚¯ãƒ©ã‚¹ãŒ SDK ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã„ã¦ã€ã“ã“ã§å„ç¨®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¦ã‚‹è‚éƒ¨åˆ†ã ã£ãŸ
        _load_configurators()
        
        # opentelemetry_instrumentor group ã«å±ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
        _load_instrumentors(distro) # flask ã¨ã‹ã§ instrument() ã—ã¦ã„ã‚‹...
        
        print("ğŸŒ´ğŸŒ´ğŸŒ´ Auto initialize opentelemetry secceeded")
    except Exception:  # pylint: disable=broad-except
        logger.exception("Failed to auto initialize opentelemetry")

print(" \n")
print("â­ï¸â­ï¸â­ï¸ ãƒ—ãƒ­ã‚»ã‚¹ã®å†èµ·å‹•ãŒãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚Šã€sitecustomize.py ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚ã“ã‚ŒãŒè‡ªå‹•è¨ˆè£…ã®çœŸéª¨é ‚ï¼ï¼ï¼ï¼")
print("ğŸ˜¡ğŸ˜¡ğŸ˜¡ ã“ã“ã§ sitecusomize.py ã® initialize() ãŒå®Ÿè¡Œé–‹å§‹")
initialize()
print("ğŸ˜¡ğŸ˜¡ğŸ˜¡ ã“ã“ã§ sitecusomize.py ã® initialize() ãŒå®Ÿè¡Œçµ‚äº†")
print("\n")
print("âœ¨âœ¨âœ¨ ä»¥é™ã¯ã€å„ Instrumentor ã®ä¸­ã®å‡¦ç†ã«å…¥ã£ã¦ã„ãã€‚ã€‚")
print("âœ¨âœ¨âœ¨ æ­£ç¢ºã«ã¯ã€ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯å´ã§ç”Ÿæˆã™ã‚‹å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã™ã§ã«è¨ˆè£…ã•ã‚ŒãŸã‚‚ã®ã€‚")
print("âœ¨âœ¨âœ¨ ãã‚Œã‚’ä½¿ã†ã“ã¨ã§ã€è‰²ã€…ãª Hook ã«ã‚ˆã‚Šè¨ˆè£…å‡¦ç†ãŒæ–½ã•ã‚Œã¦ã„ãã‚ˆã†ãªä»•çµ„ã¿")
print("\n")
### ã“ã“ã¾ã§ãŒ opentelemetry-instrument ã®é ˜åŸŸã€‚ã“ã‚Œä»¥é™ã¯
### ã“ã‚Œä»¥é™ã¯ å„ Instrumentor ã®é ˜åŸŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã§ import ã—ãŸã¨ãã¨åŒæ§˜ãªæ„Ÿã˜ã«ãªã‚Šãã†...